// ===== METADATA: One entry per EPISODE (not per part) =====
const episodesData = [
  // JinriCP S1
  { show: "JinriCP", season: 1, episode: 1, date: "", actresses: [], parts: 5 },
  { show: "JinriCP", season: 1, episode: 2, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 3, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 4, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 5, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 6, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 7, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 8, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 9, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 10, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 11, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 12, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 13, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 14, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 15, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 16, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 17, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 18, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 19, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 1, episode: 20, date: "", actresses: [], parts: 1 },

  // JinriCP S2
  { show: "JinriCP", season: 2, episode: 1, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 2, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 3, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 4, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 5, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 6, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 7, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 8, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 9, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 10, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 11, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 12, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 13, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 14, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 15, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 16, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 17, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 18, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 19, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 2, episode: 20, date: "", actresses: [], parts: 1 },

  // JinriCP S3
  { show: "JinriCP", season: 3, episode: 1, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 2, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 3, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 4, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 5, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 6, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 7, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 8, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 9, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 10, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 11, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 12, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 13, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 14, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 15, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 16, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 17, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 18, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 19, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 3, episode: 20, date: "", actresses: [], parts: 1 },

  // JinriCP S4
  { show: "JinriCP", season: 4, episode: 1, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 2, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 3, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 4, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 5, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 6, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 7, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 8, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 9, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 10, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 11, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 12, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 13, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 14, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 15, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 16, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 17, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 18, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 19, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 4, episode: 20, date: "", actresses: [], parts: 1 },

  // JinriCP S5
  { show: "JinriCP", season: 5, episode: 1, date: "", actresses: [], parts: 2 },
  { show: "JinriCP", season: 5, episode: 2, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 3, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 4, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 5, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 6, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 7, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 8, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 9, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 10, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 11, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 12, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 13, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 14, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 15, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 16, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 17, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 18, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 19, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 5, episode: 20, date: "", actresses: [], parts: 1 },

  // JinriCP S6
  { show: "JinriCP", season: 6, episode: 1, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 2, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 3, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 4, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 5, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 6, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 7, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 8, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 9, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 10, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 11, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 12, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 13, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 14, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 15, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 16, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 17, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 18, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 19, date: "", actresses: [], parts: 1 },
  { show: "JinriCP", season: 6, episode: 20, date: "", actresses: [], parts: 1 },

  // PandaClass S1
{ show: "PandaClass", season: 1, episode: 1, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 2, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 3, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 4, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 5, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 6, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 7, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 8, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 9, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 10, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 11, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 12, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 13, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 14, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 15, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 16, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 17, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 18, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 19, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 1, episode: 20, date: "", actresses: [], parts: 1 },

// PandaClass S2
{ show: "PandaClass", season: 2, episode: 1, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 2, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 3, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 4, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 5, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 6, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 7, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 8, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 9, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 10, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 11, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 12, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 13, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 14, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 15, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 16, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 17, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 18, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 19, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 2, episode: 20, date: "", actresses: [], parts: 1 },

// PandaClass S3
{ show: "PandaClass", season: 3, episode: 1, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 2, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 3, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 4, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 5, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 6, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 7, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 8, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 9, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 10, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 11, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 12, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 13, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 14, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 15, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 16, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 17, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 18, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 19, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 3, episode: 20, date: "", actresses: [], parts: 1 },

// PandaClass S4
{ show: "PandaClass", season: 4, episode: 1, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 2, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 3, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 4, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 5, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 6, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 7, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 8, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 9, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 10, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 11, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 12, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 13, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 14, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 15, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 16, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 17, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 18, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 19, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 4, episode: 20, date: "", actresses: [], parts: 1 },

// PandaClass S5
{ show: "PandaClass", season: 5, episode: 1, date: "", actresses: [], parts: 3 },
{ show: "PandaClass", season: 5, episode: 2, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 3, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 4, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 5, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 6, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 7, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 8, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 9, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 10, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 11, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 12, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 13, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 14, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 15, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 16, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 17, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 18, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 19, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 5, episode: 20, date: "", actresses: [], parts: 1 },

// PandaClass S6
{ show: "PandaClass", season: 6, episode: 1, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 2, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 3, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 4, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 5, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 6, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 7, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 8, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 9, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 10, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 11, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 12, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 13, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 14, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 15, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 16, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 17, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 18, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 19, date: "", actresses: [], parts: 1 },
{ show: "PandaClass", season: 6, episode: 20, date: "", actresses: [], parts: 1 }
];

// ===== STATE & DOM =====
const viewContainer = document.getElementById('viewContainer');
const filterBar = document.getElementById('actressFilterBar');
const backButton = document.getElementById('backButton');
let navigationStack = [];
const shows = [...new Set(episodesData.map(e => e.show))];
const allActresses = [...new Set(episodesData.flatMap(e => e.actresses))].sort();
const playerModal = document.getElementById('playerModal');
const videoPlayer = document.getElementById('videoPlayer');
const closePlayer = document.getElementById('closePlayer');
const videoTitle = document.getElementById('videoTitle');
const videoDate = document.getElementById('videoDate');
const videoActresses = document.getElementById('videoActresses');
let currentFilter = null;

// ===== NAVIGATION HELPERS =====
function pushState(state) {
  navigationStack.push(state);
  backButton.classList.toggle('visible', navigationStack.length > 0);
}

function goBack() {
  if (navigationStack.length === 0) return;
  const state = navigationStack.pop();
  backButton.classList.toggle('visible', navigationStack.length > 0);

  if (state === 'shows') {
    renderShowList();
  } else if (state.startsWith('show|')) {
    const show = state.split('|')[1];
    renderSeasonList(show);
  } else if (state.startsWith('season|')) {
    const [_, show, season] = state.split('|');
    renderEpisodeList(show, Number(season));
  } else if (state.startsWith('episode|')) {
    const [__, show, season, episode] = state.split('|');
    const ep = episodesData.find(e =>
      e.show === show &&
      e.season === Number(season) &&
      e.episode === Number(episode)
    );
    if (ep) selectPart(ep);
  }
}

// ===== RENDER VIEWS =====
function renderShowList() {
  viewContainer.innerHTML = '<h2 class="view-title">Shows</h2>';
  const grid = document.createElement('div');
  grid.className = 'grid';
  shows.forEach(show => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-img" style="background:#333;display:flex;align-items:center;justify-content:center;color:#999">${show}</div>
      <div class="card-title">${show}</div>
    `;
    card.addEventListener('click', () => {
      pushState('shows');
      renderSeasonList(show);
    });
    grid.appendChild(card);
  });
  viewContainer.appendChild(grid);
}

function renderSeasonList(show) {
  const seasons = [...new Set(
    episodesData
      .filter(e => e.show === show)
      .map(e => e.season)
      .sort((a, b) => a - b)
  )];

  viewContainer.innerHTML = `<h2 class="view-title">${show}</h2>`;
  const grid = document.createElement('div');
  grid.className = 'grid';
  seasons.forEach(season => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-img" style="background:#444;display:flex;align-items:center;justify-content:center;color:#aaa">Season ${season}</div>
      <div class="card-title">Season ${season}</div>
    `;
    card.addEventListener('click', () => {
      pushState(`show|${show}`);
      renderEpisodeList(show, season);
    });
    grid.appendChild(card);
  });
  viewContainer.appendChild(grid);
}

function renderEpisodeList(show, season) {
  const episodes = episodesData
    .filter(e => e.show === show && e.season === season)
    .sort((a, b) => a.episode - b.episode);

  viewContainer.innerHTML = `<h2 class="view-title">${show} — Season ${season}</h2>`;
  const grid = document.createElement('div');
  grid.className = 'grid';
  episodes.forEach(ep => {
    const card = document.createElement('div');
    card.className = 'card';
    const imgPath = `/${show}/Season ${ep.season}/Episode ${String(ep.episode).padStart(2, '0')}/thumb.jpg`;
    card.innerHTML = `
      <img class="card-img" src="${imgPath}" alt="Ep ${ep.episode}" onerror="this.style.display='none';this.parentElement.style.backgroundColor='#333'">
      <div class="card-title">Ep ${ep.episode}</div>
    `;
    card.addEventListener('click', () => {
      if (ep.parts === 1) {
        playEpisodePart(ep, 1);
      } else {
        pushState(`season|${show}|${season}`);
        selectPart(ep);
      }
    });
    grid.appendChild(card);
  });
  viewContainer.appendChild(grid);
}

function selectPart(ep) {
  viewContainer.innerHTML = `<h2 class="view-title">${ep.show} S${ep.season}E${ep.episode} — Select Part</h2>`;
  const grid = document.createElement('div');
  grid.className = 'grid';
  for (let i = 1; i <= ep.parts; i++) {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="card-img" style="background:#555;display:flex;align-items:center;justify-content:center;color:#ddd">Part ${i}</div>
      <div class="card-title">Part ${i}</div>
    `;
    card.addEventListener('click', () => playEpisodePart(ep, i));
    grid.appendChild(card);
  }
  viewContainer.appendChild(grid);
}

// ===== PLAYBACK =====
function playEpisodePart(ep, part) {
  const folder = `/${ep.show}/Season ${ep.season}/Episode ${String(ep.episode).padStart(2, '0')}/${part}`;
  const m3u8Url = `${folder}/index.m3u8`;
  const title = `${ep.show} S${ep.season}E${ep.episode} — Part ${part}`;

  // URL-encode to be safe
  const playerUrl = `player.html?url=${encodeURIComponent(m3u8Url)}&title=${encodeURIComponent(title)}`;

  // Open in new tab
  window.open(playerUrl, '_blank');
}

// ===== ACTRESS FILTERING =====
function applyActressFilter(actress) {
  currentFilter = actress;
  updateFilterBar();

  const filtered = episodesData.filter(e => e.actresses.includes(actress));
  const grouped = {};
  filtered.forEach(e => {
    const key = `${e.show}|${e.season}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push(e);
  });

  viewContainer.innerHTML = `<h2 class="view-title">Episodes with: ${actress}</h2>`;
  const grid = document.createElement('div');
  grid.className = 'grid';
  Object.entries(grouped).forEach(([key, eps]) => {
    const ep = eps[0];
    const card = document.createElement('div');
    card.className = 'card';
    const imgPath = `/${ep.show}/Season ${ep.season}/Episode ${String(ep.episode).padStart(2, '0')}/thumb.jpg`;
    card.innerHTML = `
      <img class="card-img" src="${imgPath}" alt="${ep.show} S${ep.season}E${ep.episode}" onerror="this.style.display='none';this.parentElement.style.backgroundColor='#333'">
      <div class="card-title">${ep.show} S${ep.season}E${ep.episode}</div>
    `;
    card.addEventListener('click', () => {
      if (ep.parts === 1) {
        playEpisodePart(ep, 1);
      } else {
        // No back from filter → episode, so we don't push state
        selectPart(ep);
      }
    });
    grid.appendChild(card);
  });
  viewContainer.appendChild(grid);
}

function clearFilter() {
  currentFilter = null;
  updateFilterBar();
  navigationStack = [];
  backButton.classList.remove('visible');
  renderShowList();
}

function updateFilterBar() {
  filterBar.innerHTML = '';
  const clearBtn = document.createElement('div');
  clearBtn.className = 'filter-tag';
  clearBtn.textContent = '← All Shows';
  clearBtn.addEventListener('click', clearFilter);
  filterBar.appendChild(clearBtn);

  const currentActresses = [...new Set(episodesData.flatMap(e => e.actresses))].sort();
  currentActresses.forEach(actress => {
    const tag = document.createElement('div');
    tag.className = 'filter-tag';
    if (currentFilter === actress) tag.classList.add('active');
    tag.textContent = actress;
    tag.addEventListener('click', () => applyActressFilter(actress));
    filterBar.appendChild(tag);
  });
}

// ===== INIT =====
closePlayer.addEventListener('click', () => {
  playerModal.classList.add('hidden');
  videoPlayer.pause();
  if (window.hls) {
    window.hls.destroy();
    window.hls = null;
  }
  videoPlayer.src = '';
});

updateFilterBar();
renderShowList();